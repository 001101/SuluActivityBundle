define(["text!massiveactivity/components/activities/activity.form.html","widget-groups","massiveactivity/model/activity"],function(a,b,c){"use strict";var d={overlayId:"activitiesOverlay",activityListSelector:"#activities-list",activityFormSelector:"#acitivity-form",activitiesURL:"/admin/api/activities/"},e=function(){return[{id:"add",icon:"plus-circle","class":"highlight-white",title:"add",position:10,callback:this.addOrEditActivity.bind(this)},{id:"settings",icon:"gear",items:[{id:"delete",title:this.sandbox.translate("contact.activities.remove"),callback:function(){this.sandbox.emit("husky.datagrid.items.get-selected",function(a){a.length>0&&this.removeActivities(a)}.bind(this))}.bind(this),disabled:!0}]}]};return{view:!0,layout:function(){return{content:{width:"fixed"},sidebar:{width:"max",cssClasses:"sidebar-padding-50"}}},templates:["/admin/activity/template/contact/activities"],initialize:function(){this.getSystemMembers().then(function(){this.bindCustomEvents(),this.render(),b.exists(this.options.widgetGroup)&&this.initSidebar(this.options.widgetGroup,this.options.id)}.bind(this))},getSystemMembers:function(){return this.sandbox.util.load("api/contacts?bySystem=true").then(function(a){this.responsiblePersons=a._embedded.contacts}.bind(this)).fail(function(a,b){this.sandbox.logger.error(a,b)}.bind(this))},initSidebar:function(a,b){this.sandbox.emit("sulu.sidebar.set-widget","/admin/widget-groups/"+a+"?"+this.options.type+"="+b)},bindCustomEvents:function(){this.sandbox.once("massive_activity.activities.set-defaults",function(a){var b,c;for(b in a)if(a.hasOwnProperty(b))for(c in a[b])a[b].hasOwnProperty(c)&&(a[b][c].translation=this.sandbox.translate(a[b][c].name));this.activityDefaults=a},this),this.sandbox.on("husky.datagrid.item.click",function(a){this.loadActivity(a)},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.router.navigate",this.getListRoute())},this),this.sandbox.on("husky.overlay.activity-add-edit.opened",function(){this.sandbox.start(d.activityFormSelector);var a=this.sandbox.form.create(d.activityFormSelector);a.initialized.then(function(){this.sandbox.form.setData(d.activityFormSelector,this.overlayData)}.bind(this))}.bind(this)),this.sandbox.dom.on("husky.datagrid.number.selections",function(a){a>0?this.sandbox.emit("husky.toolbar.activities.item.enable","delete"):this.sandbox.emit("husky.toolbar.activities.item.disable","delete")}.bind(this))},loadActivity:function(a){a?(this.activity=c.findOrCreate({id:a}),this.activity.fetch({success:function(a){this.activity=a,this.startOverlay(a.toJSON())}.bind(this),error:function(a,b){this.sandbox.logger.log("error while fetching activity",a,b)}.bind(this)})):this.sandbox.logger.warn("no id given to load activity")},setTitle:function(){var a=this.sandbox.translate("contact.contacts.title"),b=[{title:"navigation.contacts"},{title:"contact.contacts.title",event:"sulu.header.back"}];this.options.contact&&this.options.contact.id&&(a=this.options.contact.fullName,b.push({title:"#"+this.options.contact.id})),this.sandbox.emit("sulu.header.set-title",a),this.sandbox.emit("sulu.header.set-breadcrumb",b)},addOrEditActivity:function(a){a?this.loadActivity(a):this.startOverlay(null)},startOverlay:function(b){var c,e,f,g;this.sandbox.dom.remove("#"+d.overlayId),f=this.sandbox.dom.createElement('<div id="'+d.overlayId+'"></div>'),this.sandbox.dom.append(d.activityListSelector,f),this.overlayData=b,c=this.sandbox.translate(b&&b.id?"contact.contacts.activities.edit":"contact.contacts.activities.add"),g={activityType:b&&b.activityType?b.activityType.id:"",activityStatus:b&&b.activityStatus?b.activityStatus.id:"",activityPriority:b&&b.activityPriority?b.activityPriority.id:"",assignedContact:b&&b.assignedContact?b.assignedContact.id:"",activityTypes:this.activityDefaults.activityTypes,activityPriorities:this.activityDefaults.activityPriorities,activityStatuses:this.activityDefaults.activityStatuses,responsiblePersons:this.responsiblePersons,translate:this.sandbox.translate},e=this.sandbox.util.template(a,g),this.sandbox.start([{name:"overlay@husky",options:{el:f,title:c,openOnStart:!0,removeOnClose:!0,instanceName:"activity-add-edit",data:e,skin:"wide",okCallback:this.editAddOkClicked.bind(this),closeCallback:this.stopOverlayComponents.bind(this)}}])},stopOverlayComponents:function(){this.sandbox.stop(d.activityFormSelector)},editAddOkClicked:function(){if(!this.sandbox.form.validate(d.activityFormSelector,!0))return!1;var a=this.sandbox.form.getData(d.activityFormSelector);this.isContact()&&!a.contact&&(a.contact={id:this.options.id}),this.isAccount()&&!a.account&&(a.account={id:this.options.id}),a.id||delete a.id,this.save(a),this.stopOverlayComponents()},save:function(a){var b=!0;a.id&&(b=!1),this.activity=c.findOrCreate({id:a.id}),this.activity.set(a),this.activity.save(null,{success:function(a){this.activity=this.flattenActivityObjects(a.toJSON()),this.activity.assignedContact=this.activity.assignedContact.fullName,b?this.sandbox.emit("husky.datagrid.record.add",this.activity):this.sandbox.emit("husky.datagrid.records.change",this.activity)}.bind(this),error:function(){this.sandbox.logger.log("error while saving activity")}.bind(this)})},flattenActivityObjects:function(a){return a.activityStatus&&(a.activityStatus=this.sandbox.translate(a.activityStatus.name)),a.activityType&&(a.activityType=this.sandbox.translate(a.activityType.name)),a.activityPriority&&(a.activityPriority=this.sandbox.translate(a.activityPriority.name)),a},render:function(){var a;this.sandbox.dom.html(this.$el,this.renderTemplate("/admin/activity/template/contact/activities")),this.setTitle(),a="/admin/api/activities?sortBy=dueDate&sortOrder=asc&flat=true&"+this.options.type+"="+this.options.id,this.sandbox.sulu.initListToolbarAndList.call(this,"activitiesContactsFields","/admin/api/activities/fields",{el:this.$find("#list-toolbar-container"),instanceName:"activities",inHeader:!0,template:e.call(this)},{el:this.sandbox.dom.find("#activities-list",this.$el),url:a,searchInstanceName:"activities",searchFields:["subject"],resultKey:"activities",viewOptions:{table:{selectItem:{type:"checkbox"},removeRow:!1}}})},removeActivities:function(a){this.confirmDeleteDialog(function(b){if(b){var d;this.sandbox.util.foreach(a,function(a){d=c.findOrCreate({id:a}),d.destroy({success:function(){this.sandbox.emit("husky.datagrid.record.remove",a)}.bind(this),error:function(){this.sandbox.logger.log("error while deleting activity")}.bind(this)})}.bind(this))}}.bind(this))},isAccount:function(){return"account"===this.options.type},isContact:function(){return"contact"===this.options.type},getListRoute:function(){return this.isContact()?"contacts/contacts":"contacts/accounts"},confirmDeleteDialog:function(a){if(a&&"function"!=typeof a)throw"callback is not a function";this.sandbox.emit("sulu.overlay.show-warning","sulu.overlay.be-careful","sulu.overlay.delete-desc",function(){a(!1)}.bind(this),function(){a(!0)}.bind(this))}}});